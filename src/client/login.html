<!DOCTYPE html>
<html>
<head>
  <title>Login</title>
  <script src="https://unpkg.com/vue"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
  <script src='https://www.google.com/recaptcha/api.js'></script>
  <style>
    .error {
        color: red;
    }
    label {
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Login</h1>

    <template v-if="isPageReady">
      <div class="error">{{errors.global}}</div>

      <form v-on:submit.prevent="onLogin">
        <label for="username">Username</label>
        <input id="username" placeholder="username" name="username">
        <div class="error">{{errors.username}}</div>

        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Password" name="password">
        <div class="error">{{errors.password}}</div>

        <label for="rememberme">Remember me</label>
        <input id="rememberme" type="checkbox" name="rememberme">
        <div class="error">{{errors.rememberme}}</div>

        <br>
        <div id="g-recaptcha" data-sitekey="6LdWpj8UAAAAAE8wa82TL6Rd4o9qaVcV7lBinl-E"></div>
        <div class="error">{{errors['g-recaptcha-response']}}</div>

        <button type="submit">Login</button>
      </form>

      <br>
      <a href="/client/register">Register</a>
      <br>
      <a href="/client/forgot-password">Forgot password</a>
    </template>
    <template v-else>
      Fetching logged in state
    </template>
  </div>

  <script>
    var app = new Vue({
      el: '#app',
      data: {
        isPageReady: false,
        shouldDisplayCaptcha: false,
        captchaId: null,
        errors: {}
      },
      mounted() {
        this.fetchMe();

        window.addEventListener('load', () => {
          this.checkForCaptcha();
        });
      },
      methods: {
        fetchMe() {
          axios.get('/api/account/me')
            .then(response => {
              this.isPageReady = true;
              window.location.href="index";
            })
            .catch(error => {
              if (error.response && error.response.status === 401) {
                this.isPageReady = true;
              } else {
                throw error;
              }
            });
        },
        onLogin(e) {
          const data = {
            username: e.target.elements.username.value,
            password: e.target.elements.password.value,
            rememberme: e.target.elements.rememberme.checked,
            'g-recaptcha-response': e.target.elements['g-recaptcha-response'] &&
                e.target.elements['g-recaptcha-response'].value
          };

          axios.post('/api/login', data)
            .then(res => {
              window.location.href = 'index';
            })
            .catch(error => {
              this.checkForCaptcha();
              this.showErrors(error.response);
            });
        },
        showErrors(response) {          
          if (response && (response.status === 409 || response.status === 401)) {
            this.errors = {
              global: response.data.error
            };
            return;
          }

          this.errors = {
            global: 'An unexpected error occured'
          };
        },
        checkForCaptcha() {
            this.shouldDisplayCaptcha = Cookies.get('login_captcha') === 'yes';

            if (this.shouldDisplayCaptcha && window.hasOwnProperty('grecaptcha')) {
                if (this.captchaId !== null) {
                    grecaptcha.reset(this.captchaId);
                } else {
                    this.captchaId = grecaptcha.render('g-recaptcha');
                }
            }
        }
      }
    })
  </script>
</body>
</html>