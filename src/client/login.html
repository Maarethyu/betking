<!DOCTYPE html>
<html>
<head>
  <title>Login</title>
  <script src="https://unpkg.com/vue"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.min.js"></script>
  <script type="text/javascript" src="//cdn.jsdelivr.net/fingerprintjs2/1.5.1/fingerprint2.min.js"></script>
  <style>
    .error {
        color: red;
    }
    label {
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Login</h1>

    <template v-if="isPageReady">
      <div class="error">{{errors.global}}</div>

      <form v-on:submit.prevent="onLogin">
        <label for="username">Username</label>
        <input id="username" placeholder="username" name="username">
        <div class="error">{{errors.username}}</div>

        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Password" name="password">
        <div class="error">{{errors.password}}</div>

        <label for="rememberme">Remember me</label>
        <input id="rememberme" type="checkbox" name="rememberme">
        <div class="error">{{errors.rememberme}}</div>

        <button type="submit">Login</button>
      </form>

      <br>
      <a href="/client/register">Register</a>
      <br>
      <a href="/client/forgot-password">Forgot password</a>
    </template>
    <template v-else>
      Fetching logged in state
    </template>
  </div>

  <script>
    var app = new Vue({
      el: '#app',
      data: {
        isPageReady: false,
        errors: {}
      },
      mounted() {
        this.fetchMe();
        this.setFingerPrint();
      },
      methods: {
        fetchMe() {
          axios.get('/account/me')
            .then(response => {
              this.isPageReady = true;
              window.location.href="index";
            })
            .catch(error => {
              if (error.response && error.response.status === 401) {
                this.isPageReady = true;
              } else {
                throw error;
              }
            });
        },
        setFingerPrint() {
          new Fingerprint2().get((fingerprint) => this.fingerprint = fingerprint);
        },
        onLogin(e) {
          const data = {
            username: e.target.elements.username.value,
            password: e.target.elements.password.value,
            rememberme: e.target.elements.rememberme.checked,
            fingerprint: this.fingerprint
          };

          axios.post('/login', data)
            .then(res => {
              window.location.href = 'index';
            })
            .catch(error => {
              this.showErrors(error.response);
            });
        },
        showErrors(response) {          
          if (response && (response.status === 409 || response.status === 401)) {
            this.errors = {
              global: response.data.error
            };
            return;
          }

          this.errors = {
            global: 'An unexpected error occured'
          };
        }
      }
    })
  </script>
</body>
</html>