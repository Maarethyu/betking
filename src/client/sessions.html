<!DOCTYPE html>
<html>
<head>
  <title>Sessions</title>
  <script src="https://unpkg.com/vue"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
  <style>
    .error {
        color: red;
    }
    .success {
      color: green;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Sessions</h1>
    <div v-if="isLoggedIn">
      <div class="error">{{ errors.id }}</div>
      <div class="success">{{ message }}</div>

      <button v-on:click="logoutCurrent()">Logout Current</button>
      <button v-on:click="logoutAll()">Logout All</button>

      <table>
        <thead>
          <tr>
            <th>Session Id</th>
            <th>Created At</th>
            <th></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="session of sessions">
            <td>{{session.id}}</td>
            <td>{{formatDate(session.created_at)}}</td>
            <td v-if="!session.is_current">
              <button v-on:click="logoutOne(session.id)">Logout</button>
            </td>
          </tr>
        </tbody>
      </table>
      
      <br>
      <br>
      <a href="/client/index">index</a>
      <a href="/client/settings">settings</a>
    </div>
  </div>

  <script>
    var app = new Vue({
      el: '#app',
      data: {
        isLoggedIn: false,
        sessions: [],
        message: '',
        errors: ''
      },
      mounted() {
        this.getSessions();
      },
      methods: {
        getSessions() {
          axios.get('/api/account/active-sessions')
            .then(response => {
              this.isLoggedIn = true;
              this.sessions = response.data.sessions;
            })
            .catch(error => {
              if (error.response && error.response.status === 401) {
                window.location.href = 'index';
              } else {
                throw error;
              }
            })
        },
        logoutOne(id) {
          const data = { id };

          axios.post('/api/account/logout-session', data)
            .then(response => {
              this.message = 'Successfully logged out one session';
              this.error = '';
              this.getSessions();
            })
            .catch(error => {
              this.showErrors(error.response);
            })
        },
        logoutCurrent() {
          axios.post('/api/account/logout')
            .then(() => {
                this.getSessions();
            })
        },
        logoutAll() {
          axios.post('/api/account/logout-all-sessions')
            .then(() => {
                this.getSessions();
            })
        },
        formatDate(date) {
          return moment(date).format('LLL')
        },
        showErrors(response) {
          if (response && response.status === 400) {
            const newErrors = {};

            response.data.errors.forEach(error => {
              newErrors[error.param] = newErrors[error.param] ?
                `${newErrors[error.param]} / ${error.msg}` : error.msg
            });

            this.errors = newErrors;
            this.message = '';
            return;
          }
        },
      }
    })
  </script>
</body>
</html>