<!DOCTYPE html>
<html>
<head>
  <title>Register</title>
  <script src="https://unpkg.com/vue"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.min.js"></script>
  <script src='https://www.google.com/recaptcha/api.js'></script>
  <style>
    .error {
        color: red;
    }
    label {
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Register</h1>
    <div class="error">{{errors.global}}</div>

    <form v-on:submit.prevent="onRegister">
      <label for="username">Username</label>
      <input id="username" placeholder="username" name="username">
      <div class="error">{{errors.username}}</div>

      <label for="email">Email</label>
      <input id="email" placeholder="email" name="email">
      <div class="error">{{errors.email}}</div>

      <label for="email">Password</label>
      <input id="password" type="password" placeholder="Password" name="password">
      <div class="error">{{errors.password}}</div>

      <label for="password2">Confirm Password</label>
      <input id="password2" type="password" placeholder="Confirm Password" name="password2">
      <div class="error">{{errors.password2}}</div>

      <br>
      <div class="g-recaptcha" data-sitekey="6LdWpj8UAAAAAE8wa82TL6Rd4o9qaVcV7lBinl-E"></div>
      <div class="error">{{errors['g-recaptcha-response']}}</div>

      <button type="submit">Register</button>
    </form>

    <br>
    <a href="/client/login">Login</a>
  </div>

  <script>
    var app = new Vue({
      el: '#app',
      data: {
          errors: {}
      },
      methods: {
        onRegister(e) {
          console.log();
          const data = {
            username: e.target.elements.username.value,
            email: e.target.elements.email.value,
            password: e.target.elements.password.value,
            password2: e.target.elements.password2.value,
            'g-recaptcha-response': e.target.elements['g-recaptcha-response'].value
          }
          axios.post('/api/register', data)
            .then(res => {
              window.location.href = 'index';
            })
            .catch(error => {
              this.showErrors(error.response);
            })
        },
        showErrors(response) {
          if (response && response.status === 400) {
            const newErrors = {};

            response.data.errors.forEach(error => {
              newErrors[error.param] = newErrors[error.param] ?
                `${newErrors[error.param]} / ${error.msg}` : error.msg
            });

            this.errors = newErrors;   
            return;
          }
          
          if (response && response.status === 409) {
            this.errors = {
              global: response.data.error
            };
            return;
          }

          this.errors = {
            global: 'An unexpected error occured'
          };
        }
      }
    });
  </script>
</body>
</html>