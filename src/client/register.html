<!DOCTYPE html>
<html>
<head>
  <title>Register</title>
  <script src="https://unpkg.com/vue"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.0/js.cookie.min.js"></script>
  <script type="text/javascript" src="//cdn.jsdelivr.net/fingerprintjs2/1.5.1/fingerprint2.min.js"></script>
  <style>
    .error {
        color: red;
    }
    label {
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Register</h1>
    <div class="error">{{errors.global}}</div>

    <form v-on:submit.prevent="onRegister">
      <label for="username">Username</label>
      <input id="username" placeholder="username" name="username">
      <div class="error">{{errors.username}}</div>

      <label for="email">Email</label>
      <input id="email" placeholder="email" name="email">
      <div class="error">{{errors.email}}</div>

      <label for="email">Password</label>
      <input id="password" type="password" placeholder="Password" name="password">
      <div class="error">{{errors.password}}</div>

      <label for="password2">Confirm Password</label>
      <input id="password2" type="password" placeholder="Confirm Password" name="password2">
      <div class="error">{{errors.password2}}</div>

      <button type="submit">Register</button>
    </form>

    <br>
    <a href="/client/login">Login</a>
  </div>

  <script>
    var app = new Vue({
      el: '#app',
      data: {
          errors: {},
          fingerprint: null
      },
      mounted() {
        this.setAffiliateId();
        this.setFingerPrint();
      },
      methods: {
        setAffiliateId() {
          const search = window.location.search.substring(1);

          const queryStringArray = search.split('&');

          const query = {};

          queryStringArray.forEach(q => {
            const keyVal = q.split('=');

            if (keyVal.length === 2) {
              query[keyVal[0]] = keyVal[1];
            }
          });

          if (query.ref) {
            Cookies.set('aff_id', query.ref, { expires: 1 });
          }
        },
        setFingerPrint() {
          new Fingerprint2().get((fingerprint) => this.fingerprint = fingerprint);
        },
        onRegister(e) {
          const data = {
            username: e.target.elements.username.value,
            email: e.target.elements.email.value,
            password: e.target.elements.password.value,
            password2: e.target.elements.password2.value,
            fingerprint: this.fingerprint
          }
          axios.post('/register', data)
            .then(res => {
              window.location.href = 'index';
            })
            .catch(error => {
              this.showErrors(error.response);
            })
        },
        showErrors(response) {
          if (response && response.status === 400) {
            const newErrors = {};

            response.data.errors.forEach(error => {
              newErrors[error.param] = newErrors[error.param] ?
                `${newErrors[error.param]} / ${error.msg}` : error.msg
            });

            this.errors = newErrors;
            return;
          }

          if (response && response.status === 409) {
            this.errors = {
              global: response.data.error
            };
            return;
          }

          this.errors = {
            global: 'An unexpected error occured'
          };
        }
      }
    });
  </script>
</body>
</html>
